# ==============================================================================
# GHOSTKNOCK v1.1.0 - Archivo de Configuración Maestro
# ==============================================================================
# IMPORTANTE: Este archivo contiene reglas de seguridad críticas.
# Asegúrese de que los permisos sean estrictos:
#   sudo chown root:root /etc/ghostknock/config.yaml
#   sudo chmod 600 /etc/ghostknock/config.yaml
# ==============================================================================

# ------------------------------------------------------------------------------
# 1. Configuración de Red (Listener)
# ------------------------------------------------------------------------------
listener:
  # Interfaz de red donde escuchar. "any" escucha en todas (eth0, wlan0, lo).
  # Para mayor seguridad, especifique la interfaz pública (ej. "eth0").
  interface: "any"

  # Puerto UDP. GhostKnock no "abre" este puerto (no responde a pings ni escaneos),
  # simplemente lee el tráfico que pasa por él.
  port: 3001

  # (Opcional) Si su servidor tiene múltiples IPs en la misma interfaz,
  # puede restringir la escucha a una sola IP destino.
  # listen_ip: "203.0.113.10"

# ------------------------------------------------------------------------------
# 2. Configuración de Logs y Demonio
# ------------------------------------------------------------------------------
logging:
  # Niveles: "debug" (muy verboso), "info" (normal), "warn", "error".
  # Use "debug" solo para pruebas, ya que puede registrar muchos datos.
  log_level: "info"

daemon:
  # Archivo PID para integración con Systemd / Monit.
  pid_file: "/var/run/ghostknockd.pid"

# ------------------------------------------------------------------------------
# 3. Usuarios Autorizados (Users)
# ------------------------------------------------------------------------------
users:
  # --- USUARIO 1: ADMINISTRADOR (Acceso Total) ---
  - name: "admin_sysops"
    # Genere esta clave en su PC con: ghostknock-keygen
    public_key: "PEGAR_CLAVE_PUBLICA_BASE64_AQUI_USUARIO_1"
    
    # (Opcional) Capa de seguridad extra: El knock solo es válido si viene
    # de estas IPs. Útil para oficinas con IP estática o VPNs.
    source_ips:
      - "192.168.1.0/24"   # Red local
      - "80.100.200.50/32" # IP fija de la oficina

    # Acciones que este usuario puede disparar (referencias a la sección 'actions')
    actions:
      - "open-ssh"
      - "ban-ip"
      - "sys-update"
      - "emergency-lockdown"

  # --- USUARIO 2: DESARROLLADOR / CI-CD (Acceso Restringido) ---
  - name: "deploy_bot"
    public_key: "PEGAR_CLAVE_PUBLICA_BASE64_AQUI_USUARIO_2"
    # Sin restricción de source_ips porque las IPs de GitHub Actions/GitLab cambian.
    actions:
      - "deploy-app"
      - "restart-web"
      - "write-test"

# ------------------------------------------------------------------------------
# 4. Definición de Acciones (Actions)
# ------------------------------------------------------------------------------
# Aquí se define la "magia". Los comandos se ejecutan con /bin/sh.
# Variables disponibles:
#   {{.SourceIP}}   -> La IP desde la que se envió el knock.
#   {{.Params.key}} -> Argumento enviado con -args "key=val". (Solo a-z, 0-9, . _ -)

actions:
  # -------------------------------------------------------
  # [TEST] Verificación de funcionamiento y parámetros
  # Cliente: ghostknock ... -action write-test -args "p1=Hola,p2=Mundo"
  # -------------------------------------------------------
  "write-test":
    command: 'echo "Test OK. IP={{.SourceIP}} Param1={{.Params.p1}} Param2={{.Params.p2}}" > /tmp/ghostknock_test.txt'
    cooldown_seconds: 0 # Permite ejecución inmediata repetida para pruebas

  # -------------------------------------------------------
  # [ACCESO] Port Knocking 2.0 (SSH Temporal)
  # Abre el puerto 22 solo para la IP solicitante y lo cierra a los 5 min.
  # -------------------------------------------------------
  "open-ssh":
    command: "iptables -I INPUT 1 -p tcp -s {{.SourceIP}} --dport 22 -j ACCEPT"
    # El comando de reversión es OBLIGATORIO si queremos auto-cierre.
    revert_command: "iptables -D INPUT -p tcp -s {{.SourceIP}} --dport 22 -j ACCEPT"
    revert_delay_seconds: 300 # 300 segundos = 5 minutos

  # -------------------------------------------------------
  # [OPS] Reinicio de servicios con parámetro
  # Cliente: ghostknock ... -action restart-web -args "svc=nginx"
  # -------------------------------------------------------
  "restart-web":
    command: "systemctl restart {{.Params.svc}}"
    timeout_seconds: 20
    cooldown_seconds: 60 # Evita reiniciar el servicio a lo loco

  # -------------------------------------------------------
  # [SEGURIDAD] Banear IP atacante
  # Cliente: ghostknock ... -action ban-ip -args "target=1.2.3.4"
  # -------------------------------------------------------
  "ban-ip":
    command: "iptables -A INPUT -s {{.Params.target}} -j DROP"
    # Sin reversión automática; el ban es permanente hasta intervención manual.

  # -------------------------------------------------------
  # [DEPLOY] Despliegue de código (Principio de Mínimo Privilegio)
  # Cliente: ghostknock ... -action deploy-app -args "branch=main"
  # -------------------------------------------------------
  "deploy-app":
    # Ejecuta como 'www-data', NO como root. Mucho más seguro.
    run_as_user: "www-data"
    command: "cd /var/www/html && git fetch && git checkout {{.Params.branch}} && git pull"
    timeout_seconds: 60

  # -------------------------------------------------------
  # [MANTENIMIENTO] Actualización del Sistema
  # Una tarea larga que requiere un timeout generoso.
  # -------------------------------------------------------
  "sys-update":
    command: "apt-get update && apt-get upgrade -y"
    timeout_seconds: 900    # 15 minutos máximo
    cooldown_seconds: 3600  # Solo una vez por hora

  # -------------------------------------------------------
  # [EMERGENCIA] Lockdown (Cerrar todo)
  # -------------------------------------------------------
  "emergency-lockdown":
    command: "iptables -P INPUT DROP" 
    # No hay parámetros ni reversión. Es un botón del pánico.

  # -------------------------------------------------------
  # [WOL] Wake on LAN
  # Cliente: ghostknock ... -action wol -args "mac=aa-bb-cc-dd-ee-ff"
  # Nota: Usar guiones en la MAC, los dos puntos ':' no están permitidos.
  # -------------------------------------------------------
  "wol":
    command: "wakeonlan {{.Params.mac}}"
